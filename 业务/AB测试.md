# 业务目标→衡量指标→用户群体→分组方式→采样周期→实验配置→实验分析→实验落地
## 业务目标
A/B 实验是目标导向的，在实验之前发起者需要确定以下几个问题：该实验的业务目标是什么？想要提升的核心指标是什么？预期可以提升多少？可能会对什么指标产生负向影响？

## 衡量指标
* 基于上述的业务目标，确定1至2个实验观测的核心指标（P0），该指标显著正向（或者是无显著负向）是实验全量上线的必要条件；
* 拟定3至10个辅助观测指标（P1），用来观测实验对其他指标的影响，以及当核心指标出现显著负向时，可通过辅助观测指标定位分析原因，方便后续迭代。

## 用户群体
确定实验的目标用户群体是哪些，仅针对该部分用户进行 A/B 实验的参数配置生效，其他用户为线上正常用户。后续进行实验分析时，主要针对该目标群体进行分析。

## 分组方式
当目标用户群体较大时（如占 DAU 的 10%），考虑工程的实现成本可以直接进行全局 DAU的随机切分，这样做可行的背后的逻辑是样本量足够大后，两组的分布趋同，同质性可以保证。
然而，如果针对的用户量级较小，且用户的筛选逻辑复杂时，数量 & 多层过滤都会影响同质性，这时则不能在一开始就做全局的切分，而是在定位到该部分人群之后再进行 A/B 分组。

举个例子：现在有一副扑克牌（ 1~K，4 种花色，共 52 张），我们需要对其中的花牌（J、Q、K，共 12 张）进行分组，分成 4 组，每组 3 张。
方法一是先找出 52 张牌中的 12 张花牌，再将 12 张花牌分成 4 组，此方法可以准确地对花牌进行分组，缺点是需要先进行一步「寻找花牌」的操作；
方法二是直接将 52 张牌分为 4 组，按照概率计算，每组内的花牌期望值也是 3 张。
但可想而知，方法二在实际操作过程中，想要得到 4 组内的花牌都是 3 张的概率极小（可以计算，概率不超过 1%），甚至有的组里没有花牌，即分组不同质。
但是，在样本量足够大的情况下，如我们有 52 万张扑克牌，其中 12 万张花牌，需要分成 4 组，每组 3 万张，按照方法二，对 52 万张牌直接分为 4 组，
虽然基本得不到「每组刚好 3 万张」的情况，但是组与组之间的误差已经很小，可以认为组与组之间基本同质；

## 采样周期
* 基于核心优化指标的期望变化幅度确定最小样本量。综合衡量样本量 & 时间周期后，确定数据的采集周期，同时也是分析的时长。
* 在计算最小样本量时，需要输入的变量为「实验预期带来的数值差异」「实验指标的方差」「alpha」「检验 power」。其中后两者默认为 0.1（双边检验） & 80%，可以不作额外考虑。前两者则更具有业务意义。由于预期带来的差异与所需样本量呈反比关系，差异越大，则所需的样本量越小，在对接时，应与业务方明确该实验所能带来的最小预期收益，并基于该预期计算最小样本量。
* 可以参考下面的工具进行最小样本量的计算  [最小样本量计算](https://www.evanmiller.org/ab-testing/sample-size.html)
* 在实际的实验过程中，考虑到周期性的影响，大部分的实验都会选择以一周为最短时间周期。但如果是一些立竿见影式的实验，如首页推荐策略改进，则可以根据实际数据变化情况缩短实验时间。

## 实验配置
* 实验层的确定
* 流量的分配
* A/A 实验
* 实验放量操作
* 实验回滚操作

## 实验分析
当前主流的 A/B 实验显著性检验方法有如下几种：
* Z 检验
* 独立样本 T 检验
* 配对样本 T 检验
* 卡方检验（使用相对较少，暂不讨论）

我们以下面的实例来演示各个显著性检验的使用方法：

|日期	|曝光UV	|点击UV	|CTR	|曝光UV	|点击UV	|CTR|
|-|-|-|-|-|-|-|
|2022-01-01|	ma1	|na1|	Pa1	|mb1	|nb1	|Pb1|
|2022-01-02|	ma2	|na2|	Pa2	|mb2	|nb2	|Pb2|
|2022-01-03|	ma3	|na3|	Pa3	|mb3	|nb3	|Pb3|
|2022-01-04|	ma4	|na4|	Pa4	|mb4	|nb4	|Pb4|
|2022-01-05|	ma5	|na5|	Pa5	|mb5	|nb5	|Pb5|
|2022-01-06|	ma6	|na6|	Pa6	|mb6	|nb6	|Pb6|
|均值  |	ma^	| na^|	Pa^|	mb^|	nb^|	Pb^|

### Z 检验
针对某一天（如2022-01-01）的数据，已知实验组&对照组的曝光 UV 和 CTR（ ma1、Pa1、mb1、Pb1），构建符合标准正态分布的 Z 统计量
$$z = frac{Pa1-Pb1}{\sqrt{frac{Pa1*(1-Pa1)}{ma1}+frac{Pb1*(1-Pb1)}{mb1}}}$$
根据计算出来的 Z 值，对比概率密度函数值可得对应的 P_value。
注意，上述检验的是比率型指标，有时我们需要检验的是数值型指标，如「人均使用时长」等，此时 Z 统计量为：


其中 Sa 为实验组样本方差，Sb 为对照组样本方差。（底层的统计学原理是，对于二项分布，其方差 S = p(1-p) ）。
对于 Z 检验有以下几个问题：
* 如果实验有多天数据，那么是否是对每一天重复进行上述检验，还是将多天数据汇总成一个数据进行检验？如果汇总的话，怎么汇总？（用户多日曝光是否去重？多日点击是否去重？）
* 当样本量足够大的时候，理论上此时可以检验出很小的实验误差（参见上述计算样本量环节），此时实验组和对照组的极微小的误差都可以被测试出显著差异，显著性检验失效（此时直接对比指标大小 就可以了）

### 独立样本 T 检验
针对上述例子中的数据，我们有实验组和对照组 6 日的 CTR 数据，则可以计算出各自组内CTR 数据的均值和标准差，然后套用如下公式（注意这里要求实验组和对照组数据样本服从正态分布）：
得到 t 值后，查表可得对应 P_value（参考：[知乎链接](https://www.zhihu.com/question/359497751/answer/924458823)）

### 配对样本 T 检验
正如检验名称，该方法需要将实验组和对照组的数据进行配对，这就要求实验组和对照组的样本量必须一致，否则无法完成配对，其本质的逻辑和独立样本 T 检验基本类似，只是独立样本是将样本 A 和样本 B 的指标就行对比，而配对样本是将样本 A 和 B 的指标差值和0作对比，其在计算公式上更偏向于单样本 T 检验。

**在 Excel 中可以使用 ttest 函数去计算独立样本 T 检验和配对样本 T 检验的 p_value（注意使用函数的参数控制独立样本 T 检验还是配对样本 T 检验）**


独立样本 T 检验和配对样本 T 检验虽然逻辑很相似，但是还是有一定差异，比如我们前面说到的配对问题，再一点就是，配对样本 T 检验抹杀了各个样本组内部的数据波动情况，而只研究组间差异，但独立样本 T 检验的结果不仅取决于之间差异，也受组内数据波动影响。举个例子，如果实验组在试验周期内每天都比对照组高 0.1%，那么用配对样本 T 检验计算，则结果必然是显著的。但假如实验组和对照组在实验周期内本身数据波动很大（比如实验组数据在不同日期下波动差值可以达到 10%），那么用独立样本 T 检验则可能检验不出这 0.1% 的差异。
另外，我们可以看到，在使用独立样本 T 检验和配对样本 T 检验计算上述例子的时候，我们的样本量其实只有 6 个（即实验组&对照组都只有 6 天 CTR 的数据，这和我们之前计算最小样本量的逻辑是冲突的，即本质上并不是同一个方法）。


Z检验看起来更加科学，决策时间也更短，但是其受数据量影响很大，即在大样本情况下很容易得到显著的结果，但是这种显著的结果放到线上可能效果不会很好。相比之下独立样本T检验的过程更长，要求更严格，线上的结果也会更加符合预期。



## 实验落地
根据实验分析对该实验进行相应的处理（放量 or 下线）。另外，考虑到小流量实验在放量至大流量之后，结论可能会发生变化，放量时可放至 90% 或 95% ，剩余 5% 或 10% 流量再对比一段时间，确认在大流量情况下，前期实验结论依旧成立时，可放至全量。


## 常见问题
### 新奇效应
在 A/B 实验中，试验早期用户因为新奇会关注新改动，但是往往前期显著的提升在之后几天或者几周的测试中会逐渐消失。常用的解决方法有2个，一是使用新用户作为实验对象，排除新奇效应，此方法对新用户数量要求较高；二是延长实验周期，使用稳定后的实验数据进行对比，此方法缺点是决策时间变长；

### 辛普森悖论
辛普森悖论的现象和原理不多做解释，可自行百度。一般AB实验中不会出现辛普森悖论现象，因为实验流量前期分配会被要求同质，且流量大小相对均匀且稳定，因此很少会有辛普森悖论出现，一旦问题出现了，先从流量分配上找问题。

### 以偏概全
常见的问题如实验周期太短，没有覆盖低活跃用户，只在高活跃用户上进行了实验，得到结果后迅速上线，后发现全量后效果不如预期。此问题在实际使用中影响不大，一是因为实验周期一般不会太短，尽量覆盖到各种人群，对于实验周期内都无法覆盖的人群，一般都是因为其业务渗透率低，对于这部分人群，即使后续全量，也不会对结果造成颠覆性的影响；
